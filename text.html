<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearby Stores</title>
    <!-- Include Leaflet CSS file in the head section of your document:-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <!-- Include Leaflet JS file -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

    <style>
        #map { height: 550px; width: 100%; }
        #stores-list { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Nearby Stores</h1>
    <div id="map"></div>
    <h2>Stores within your location:</h2>
    <ul id="stores-list"></ul>
</body>

<script>
    var map = L.map('map').setView([51.505, -0.09], 13); // Sets initial coordinates and zoom level

    // Sets map data source and associates with map
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    let marker, circle, zoomed;
    let stores = []; // Array to store nearby stores

    navigator.geolocation.watchPosition(success, error);

    function success(pos) {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const accuracy = pos.coords.accuracy;

        if (marker) {
            map.removeLayer(marker);
            map.removeLayer(circle);
        }
        // Removes any existing marker and circle (new ones about to be set)

        marker = L.marker([lat, lng]).addTo(map);
        circle = L.circle([lat, lng], { radius: accuracy }).addTo(map);
        // Adds marker to the map and a circle for accuracy

        if (!zoomed) {
            zoomed = map.fitBounds(circle.getBounds());
        }
        // Set zoom to boundaries of accuracy circle

        map.setView([lat, lng]);
        // Set map focus to current user position

        // Fetch and display nearby stores within the accuracy radius
        findNearbyStores(lat, lng, accuracy);
    }

    function error(err) {
        if (err.code === 1) {
            alert("Please allow geolocation access");
        } else {
            alert("Cannot get current location");
        }
    }

    function findNearbyStores(lat, lng, radius) {
        const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node(around:${radius},${lat},${lng})[shop];out;`;

        fetch(overpassUrl)
            .then(response => response.json())
            .then(data => {
                // Clear the stores array and HTML list before adding new stores
                stores = [];
                const storesList = document.getElementById('stores-list');
                storesList.innerHTML = '';

                data.elements.forEach(store => {
                    const storeLocation = [store.lat, store.lon];
                    L.marker(storeLocation).addTo(map)
                        .bindPopup(store.tags.name || "Unnamed store");

                    // Add the store to the stores array
                    const storeName = store.tags.name || "Unnamed store";
                    stores.push({
                        name: storeName,
                        location: storeLocation
                    });

                    // Add the store name to the HTML list
                    const li = document.createElement('li');
                    li.textContent = storeName;
                    storesList.appendChild(li);
                });

                // Log the stores array to the console for debugging
                console.log(stores);
            })
            .catch(error => console.error('Error:', error));
    }
</script>
</html>
